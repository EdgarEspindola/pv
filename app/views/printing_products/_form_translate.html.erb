<%= form_tag(transfer_printing_products_url, html: { class: "form-horizontal" }) do |f| %>
  <div class="box-body">
    <div class="form-group">
      <label class="col-sm-2 control-label">Código</label>
      <%= hidden_field_tag 'translate[source_product_id]', @printing_product.id %>
      <div class="col-sm-10">
        <%= text_field_tag "translate[code]", nil, class: "form-control", required: true, readonly: true %>
      </div>
    </div>

    <div class="form-group">
      <label class="col-sm-2 control-label">Nombre</label>
      <div class="col-sm-10">
        <%#= text_field_tag "translate[name]", nil, class: "form-control translate-name", required: true %>
        <%= select_tag "translate[destination_product_id]", options_for_select([]), { class: 'form-control translate-name', required: true, prompt: "Buscar producto" } %>
      </div>
    </div>

    <div class="form-group">
      <label class="col-sm-2 control-label">Stock</label>
      <div class="col-sm-5">
        <%= text_field_tag "translate[unit_to_discount]", @total_units, class: "form-control", required: true %>
      </div>
      <div class="col-sm-5">
        <%= text_field_tag "translate[stock_unit]", @printing_product.contain_unit, class: "form-control", required: true, autofocus: true, readonly: true %>
      </div>
    </div>

    <div class="form-group">
      <label class="col-sm-2 control-label">Fotografia</label>
      <div class="col-sm-10">
        <img id="img_product" width=200 height=200 src="" alt="Fotografia" class="img-thumbnail"/>
      </div>
    </div>

  <div class="box-footer">
    <%= submit_tag "Guardar", id:"btn_save_form_translate_printing_product", class: "btn btn-info pull-right btn-block" %>
  </div>

<% end %>

<script>
  $(document).ready(function() {
    var unitContains = $("#translate_stock_unit").val(); // Piezas, Metros del producto del que se realizará el descuento
    var unitProductToAdd = ""; // Es la unidad del producto al que se le agregara las unidades
    var minimumProductContain = 0; // Minima cantidad de piezas o metros que componen su unidad
    var $unitToDiscount = $("#translate_unit_to_discount");
    var $btnSaveFormTranslate = $("#btn_save_form_translate_printing_product");

    $('.translate-name').select2({
      dropdownParent: $('#form-modal'),
  		minimumInputLength: 1,
  		ajax: {
  			delay: 250,
  			url: "/printing_products/autocomplete?product_id=<%= @printing_product.id %>",
  			dataType: 'json',
  			cache: true
  		}
  	});
    $('.translate-name').on('select2:select', function (e) {
        var data = e.params.data;
        console.log(data);
        //$("#tra").val(data.name);
        $("#translate_code").val(data.code);
        $("#img_product").attr("src", data.url_img);
        unitProductToAdd = data.contain_unit;
        minimumProductContain = parseInt(data.contains);
        checkStockIsMinimum($unitToDiscount.val());
    });

    // Verificar stock a agregar cumple con la cantidad
    // minima de piezas, metros en producto destino
    $unitToDiscount.keyup(function() {
      var stockToAdd = $(this).val();
      checkStockIsMinimum(stockToAdd);
    });

    function checkStockIsMinimum(stockToAdd) {
      console.log("unitProductToAdd: " + unitProductToAdd);
      console.log("unitContains: " + unitContains);
      if(unitProductToAdd != "" && unitProductToAdd == unitContains ) {
        console.log("Hay que validar que el stock agregado sea multiplo del minimo");
        if((parseInt($unitToDiscount.val()) % minimumProductContain) == 0) {
          console.log("El stock a agregar es un multiplo del minimo del producto destino");
          toastr["info"]("Stock correcto.");
          $btnSaveFormTranslate.removeAttr('disabled');
        } else {
            toastr["error"]("Stock no cumple con la unidad destino.");
            $btnSaveFormTranslate.attr('disabled', true);
        }
      } else {
        console.log("El stock se agrega de manera directa.");
        //toastr["info"]("El stock se agrega de manera directa.");
        $btnSaveFormTranslate.removeAttr('disabled');
      }
    }
  });
</script>
